# Разработчикам бэкенда

[toc]

## Как развернуть local-окружение

### Необходимое ПО

Для запуска ПО вам понадобятся uv, консольный Git, Make, Docker и Docker Compose. Инструкции по их установке ищите на
официальных сайтах:

- [uv](https://docs.astral.sh/uv/)
- [Git SCM](https://git-scm.com/)
- [GNU Make](https://www.gnu.org/software/make/)
- [Get Started with Docker](https://www.docker.com/get-started/)

Для тех, кто использует Windows необходимы также программы **git** и **git bash**. В git bash надо добавить ещё команду
make:

- Go to [ezwinports](https://sourceforge.net/projects/ezwinports/files/)
- Download make-4.2.1-without-guile-w32-bin.zip (get the version without guile)
- Extract zip
- Copy the contents to C:\ProgramFiles\Git\mingw64\ merging the folders, but do NOT overwrite/replace any exisiting
  files.

Все дальнейшие команды запускать из-под **git bash**.


### Подготовка файла .env

Для локального развертывания приложения необходимо создать в корне проекта файл `.env`. Сейчас можете оставитье его пустым:

```shell
$ touch .env
```

Позже в этом файле вы сможете указать дополнительные переменные окружения с настройками для Fastapi.

Этот файл предназначен для локальных настроек, и поэтому уже добавлен в .gitignore.

### Настройка pre-commit хуков

В репозитории используются хуки pre-commit, чтобы автоматически запускать линтеры и автотесты. Перед началом разработки
установите [pre-commit package manager](https://pre-commit.com/).

В корне репозитория запустите команду для настройки хуков:

```shell
$ pre-commit install
```

В последующем при коммите автоматически будут запускаться линтеры и автотесты. Есть линтеры будет недовольны, или
автотесты сломаются, то коммит прервётся с ошибкой.

### Создание виртуального окружения для работы с IDE

IDE для корректной работы подсказок необходимо развернуть виртуальное окружение со всеми установленными зависимостями.
Создать его можно с помощью uv командой

```shell
uv sync --frozen
```

IDE обычно автоматически подключаются к созданной в проекте папке `.venv`. Эта папка добавлена в `.gitignore`.

## Работа с кодом с использованием docker

Сначала скачайте и соберите докер-образы с помощью Docker Сompose:

```shell
$ docker compose build
```

Запустите докер-контейнеры и не выключайте:

```shell
$ docker compose up
```

**Важно!** Дождитесь полного запуска контейнеров

Накатить миграции можно с помощью команды:

```shell
$ make migrate
```

Для создания суперпользователя воспользуйтесь командой:

```shell
$ make createsuperuser
```

После этого вы сможете зайти в админку.

## Как вести разработку

Все файлы из каталога `src` смонтированы в docker-контейнер, а веб-сервер запущен в режиме live-reload,
поэтому изменение кода на компьютере сразу отражается на запущенном в local-окружении сайте.
Если веб-сервер "упал", то следует остановить контейнеры и перезапустить команду:

```shell
$ docker compose up
```

### Команды для быстрого запуска с помощью make

Для часто используемых команд Docker Compose подготовлен набор альтернативных коротких команд `make`.

```shell
$ make help
Cписок доступных команд:
lint                      Проверяет линтерами код в репозитории
format                    Автоматически исправляет форматирование кода -- порядок импортов, лишние пробелы и т.д.
migrations                Создаёт новые файлы миграци
migrate                   Применяет новые миграции
tests                     Запускает автотесты
```

### Как обновить local-окружение

Чтобы обновить local-окружение до последней, версии подтяните код из центрального окружения и пересоберите докер-образы:

``` shell
$ git pull
$ docker compose build
$ make migrate
```

### Как установить python-пакет

В качестве менеджера пакетов используется [uv](https://docs.astral.sh/uv/).

Конфигурационные файлы `pyproject.toml` и `uv.lock` проброшены в контейнер в виде volume, поэтому изменения
зависимостей попадают в контейнер.

Вот пример как добавить в зависимости библиотеку pydantic.

```shell
$ uv add pydantic
```

Конфигурационные файлы `pyproject.toml` и `poetry.lock` обновятся внутри контейнера. Чтобы все новые контейнеры также
получали свежий набор зависимостей не забудьте обновить докер-образ:

```shell
$ docker compose build
```

Аналогичным образом можно удалять python-пакеты:

```shell
$ uv remove pydantic
```
